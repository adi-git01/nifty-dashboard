name: Alpha Trend Engine

on:
  schedule:
    # 3:15 PM IST = 9:45 AM UTC (Mon-Fri)
    - cron: '45 9 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-trading-engine:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Crucial for git-auto-commit-action
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        
    - name: Execute Trading Engine (Full Cycle)
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        python trading_engine.py --mode full
        
    - name: Commit State Changes (SQLite CSVs & Parquet)
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ðŸ¤– System: EOD Engine Check (Cache, SQLite Ledger, Sub-Industries)"
        file_pattern: 'data/*.csv data/cache/*.parquet positions.json'

    - name: ðŸš¨ Notify on Crash (Telegram & Email)
      if: failure()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
      run: |
        python -c "
        import os, requests, smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        
        msg = 'ðŸš¨ <b>CRITICAL PIPELINE FAILURE</b> ðŸš¨\n\nThe Alpha Trend Engine crashed during the 3:15 PM run!\n\n<b>Reason:</b> Process exited with fatal code.\nPlease check the GitHub Actions logs immediately.'
        
        token = os.environ.get('TELEGRAM_TOKEN')
        chat_id = os.environ.get('TELEGRAM_CHAT_ID')
        if token and chat_id:
            try: requests.post(f'https://api.telegram.org/bot{token}/sendMessage', json={'chat_id': chat_id, 'text': msg, 'parse_mode': 'HTML'}, timeout=10)
            except: pass
            
        user = os.environ.get('GMAIL_ADDRESS')
        pwd = os.environ.get('GMAIL_APP_PASSWORD')
        if user and pwd:
            em = MIMEMultipart()
            em['From'] = user
            em['To'] = user
            em['Subject'] = 'ðŸš¨ CRITICAL PIPELINE FAILURE ðŸš¨'
            em.attach(MIMEText(msg.replace('\n', '<br>'), 'html'))
            try:
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(user, pwd)
                server.send_message(em)
                server.quit()
            except: pass
        "
