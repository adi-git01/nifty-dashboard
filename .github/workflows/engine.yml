name: Alpha Trend Engine

on:
  schedule:
    # 3:15 PM IST = 9:45 AM UTC (Mon-Fri)
    - cron: '45 9 * * 1-5'
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-trading-engine:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Crucial for git-auto-commit-action
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install pandas yfinance pyarrow fastparquet requests numpy
        
    - name: Execute Trading Engine (Full Cycle)
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python trading_engine.py --mode full
        
    - name: Commit State Changes (SQLite CSVs & Parquet)
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ðŸ¤– System: EOD Engine Check (Cache, SQLite Ledger, Sub-Industries)"
        file_pattern: 'data/*.csv data/cache/*.parquet positions.json'
